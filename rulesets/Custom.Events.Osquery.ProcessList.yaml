name: Custom.Events.Osquery.ProcessList
type: CLIENT_EVENT
description: Periodically query running processes via osquery
parameters:
  - name: Period
    default: "60"
  - name: OsqueryPath
    default: "C:\\Program Files\\osquery\\osqueryi.exe"
  - name: Query
    default: "SELECT pid, name, path, cmdline, uid, parent FROM processes"
sources:
  - precondition:
      SELECT OS FROM info() WHERE OS = "windows"
    query: |
      SELECT * FROM foreach(
        row={SELECT now() AS Tick FROM clock(period=atoi(string=Period))},
        query={
          LET result = SELECT * FROM execve(
            argv=[OsqueryPath, "--json", Query],
            length=10000000)
          SELECT * FROM foreach(row=result,
            query={SELECT Tick, * FROM parse_json_array(data=Stdout)})
        })
